{inc:header.htm}
<div class="nav">
    <ul class="cc">
        <li><a href="index.php?u=product-index">产品列表</a></li>
        <li class="current"><a href="index.php?u=product-add">添加产品</a></li>
      </ul>
</div>
<style type="text/css">
.wrap {
    padding: 20px 20px 70px;
}
.col-auto {
	overflow: hidden;
	_zoom: 1;
	_float: left;
	border: 1px solid #c2d1d8;
}
.col-right {
	float: right;
	width: 210px;
	overflow: hidden;
	margin-left: 6px;
	border: 1px solid #c2d1d8;
}

body fieldset {
	border: 1px solid #D8D8D8;
	padding: 10px;
	background-color: #FFF;
}
body fieldset legend {
    background-color: #F9F9F9;
    border: 1px solid #D8D8D8;
    font-weight: 700;
    padding: 3px 8px;
}
</style>

<div class="J_check_wrap contadd">
    <form name="myform" id="myform" action="index.php?u=product-{$_GET['action']}" method="post" class="J_ajaxForms" enctype="multipart/form-data">
        <div class="col-right">
            <div class="table_full">
                <table width="100%">
                    <tr>
                        <td><b>缩略图</b></td>
                    </tr>
                    <tr>
                        <td>
                            <div style="text-align: center;">
                                <input type='hidden' name='info[pic]' id='maybe_pic_val' value='{$data[pic]}'>
                                <div class="picimg">
                                	<img src='{$data[pic_src]}' id='maybe_pic_img' style='cursor:hand' />
                                </div>
                                <a id="maybe_pic_but" class="btn" href="javascript:;">上传缩略图</a>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td><b>评论</b></td>
                    </tr>
                    <tr>
                        <td>
                            <label>
                                <input type="radio" name='info[iscomment]' id="allow_comment_1" {if:$data[iscomment] == 0}checked{/if} value="0">允许评论
                            </label>
                            <label>
                                <input type="radio" name='info[iscomment]' id="allow_comment_0" {if:$data[iscomment] == 1}checked{/if} value="1">禁止评论
                            </label>
                            <span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><b>责任编辑</b></td>
                    </tr>
                    <tr>
                        <td>
                            <span class="switch_list cc">
                                  <input type="text" name="info[author]" value="{$data[author]}" maxlength="20">
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><b>来源</b></td>
                    </tr>
                    <tr>
                        <td>
                            <span class="switch_list cc">
                                  <input type='text' name='info[source]' value='{$data[source]}' placeholder='请输入内容来源'>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><b>排序值</b></td>
                    </tr>
                    <tr>
                        <td>
                            <span class="switch_list cc">
                                  <input type="text" name="info[listorder]" value="{$data[listorder]}">
                                  <div class="gray">请输入非负整数的排序值</div>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><b>浏览量</b></td>
                    </tr>
                    <tr>
                        <td>
                            <span class="switch_list cc">
                                  <input type="text" name="views" value="{$data[views]}">
                                  <div class="gray">请输入非负整数的浏览量</div>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><b>URL别名</b></td>
                    </tr>
                    <tr>
                        <td>
                            <span class="switch_list cc">
                                  <input type='text' name='info[alias]' value='{$data[alias]}' placeholder='请输入URL别名'>
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="col-auto">
            <div class="h_a">
                信息发布
            </div>
            <div class="table_full">
            	<input type="hidden" name="info[id]" value="{$data[id]}">
                <table width="100%">
                    <tr>
                        <th width="80">分类</th>
                        <td>
                            {$cidhtml}<span class="red">*</span>
                        </td>
                    </tr>
                    <tr>
                        <th>标题</th>
                        <td>
                            <input type="text" name="info[title]" id="title" value="{$data[title]}" style='width:280px' placeholder="请输入标题" />
                            <span class="red">*</span>
                        </td>
                    </tr>
                    
                    <tr>
                        <th>标签</th>
                        <td>
                            <input type='text' name='info[tags]' id='tags' value='{$data[tags]}' style='width:280px'
                            class='input' placeholder='请输入Tags标签'>
                            <span class="gray">多个标签之间用空格或者“,”隔开，最多5个标签</span>
                        </td>
                    </tr>
                    <tr>
                        <th>摘要</th>
                        <td>
                            <textarea name='info[intro]' style='width:98%;height:46px;'>{$data[intro]}</textarea>
                        </td>
                    </tr>
                    <tr>
                        <th>SEO标题</th>
                        <td>
                            <input type='text' name='info[seo_title]' value='{$data[seo_title]}' style='width:280px' placeholder='请输入SEO标题'>
                        </td>
                    </tr>
                    <tr>
                        <th>SEO关键词</th>
                        <td>
                            <input type='text' name='info[seo_keywords]' value='{$data[seo_keywords]}' style='width:280px' placeholder='请输入SEO关键词'>
                            <span class="gray">多个关键词之间用“,”隔开</span>
                        </td>
                    </tr>
                    <tr>
                        <th>推荐位 </th>
                        <td>
                        	<label><input class="mr3" name="info[flags]" type="radio" value="0"{if:$data[flags]==0} checked{/if}>暂无</label>
                            <label><input class="mr3" name="info[flags]" type="radio" value="1"{if:$data[flags]==1} checked{/if}>推荐</label>
							<label><input class="mr3" name="info[flags]" type="radio" value="2"{if:$data[flags]==2} checked{/if}>热点</label>
							<label><input class="mr3" name="info[flags]" type="radio" value="3"{if:$data[flags]==3} checked{/if}>头条</label>
							<label><input class="mr3" name="info[flags]" type="radio" value="4"{if:$data[flags]==4} checked{/if}>精选</label>
							<label><input class="mr3" name="info[flags]" type="radio" value="5"{if:$data[flags]==5} checked{/if}>幻灯</label>
                        </td>
                    </tr>
                    <tr>
                        <th>图集</th>
                        <td>
                            <div id="maybe_dropbox" class="cf">
								{loop:$data[images] $v $k}
								<div class="d_li">
									<div class="d_img"><img src="../{$v[thumb]}" height="120" width="120" style="margin-top: -10px;"></div>
									<div class="d_txt">
										<input name="images[{$k}][big]" value="{$v[big]}" type="hidden">
										<input name="images[{$k}][thumb]" value="{$v[thumb]}" type="hidden">
										<input name="images[{$k}][aid]" value="{$v[aid]}" type="hidden">
										<textarea name="images[{$k}][content]" placeholder="请输入描述">{php}echo htmlspecialchars($v['content']);{/php}</textarea>
									</div>
									<div class="d_del" aid="{$v[aid]}">删除</div>
								</div>
								{/loop}
								<div id="maybe_imgup" class="d_li2">
									<div><a id="maybe_img_but" class="btn" href="javascript:;">上传图片</a></div>
									<div id="maybe_img_tips"></div>
								</div>
							</div>
                        </td>
                    </tr>
                    <tr>
                        <th>内容</th>
                        <td>
                            <textarea name='data_info[content]' id='content' style="width:99%;">{$data[content]}</textarea>
                        	<div class="addition">
								<label title="远程抓取图片比较消耗服务器资源，影响发布速度">
									<input name="isremote" type="checkbox" value="1"> 远程图片本地化
								</label>
							</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="btn_wrap" style="text-align: center;">
            <div class="btn_wrap_pd">
                <button class="btn btn_submit J_ajax_submit_btn1" type="submit"> 提交</button>
            </div>
        </div>
    </form>
</div>

<iframe name="maybe_upifr" style="display:none"></iframe>
<form id="maybe_pic_upform" target="maybe_upifr" method="post" enctype="multipart/form-data" action="index.php?u=attach-upload_image&type=pic{$edit_cid_id}">
	<input id="maybe_pic_upfile" type="file" name="upfile" accept="image/jpg,image/jpeg,image/png,image/gif" />
</form>
<form id="maybe_img_upform" target="maybe_upifr" method="post" enctype="multipart/form-data" action="index.php?u=attach-upload_image&type=img{$edit_cid_id}">
	<input id="maybe_img_upfile" type="file" name="upfile" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="multiple" />
</form>

<script type="text/javascript">
//自动保存
var action = "{$_GET['action']}";
window.autoSave = function() {
	if(action != "add") return;
	var data = $("#myform").serialize();
	maybeAjax.post("index.php?u=product-auto_save-ajax-1", data, function(html) { });
};

// 编辑时保存图集
window.editSaveImg = function() {
	if(action != "edit") return;
	var data = $("#myform").serialize();
	maybeAjax.post("index.php?u=product-save_images-ajax-1", data, function(html) { });
};

// 传统上传缩略图
document.getElementById("maybe_pic_upfile").onchange = function() {
	document.getElementById("maybe_pic_upform").submit();
};

//====拖拽图片上传====
window.isDrop = !!window.FileReader;
var kpUpload = {
	init : function() {
		if(!window.TW_UP) window.TW_UP = true;

		if(isDrop) {
			$("#maybe_img_tips").html("支持拖拽上传");

			//ajax上传图集
			$("#maybe_img_upfile").change(function() {
				$("#maybe_img_upfile").hide();
				kpUpload.ajaxUpload(this.files);
			});

			//加载 HTML5 拖拽上传图集
			kpUpload.ondrag();
		}else{
			$("#maybe_imgup div").css("padding-top", "10px");
			$("#maybe_img_tips").html("您的浏览器太老，不支持拖拽上传，建议使用IE10以上版本或chrome");

			//传统上传图集
			document.getElementById("maybe_img_upfile").onchange = function() {
				document.getElementById("maybe_img_upform").submit();
			};
		}
	},

	//绑定拖拽事件  提示: ondragover(当元素被拖动至有效拖放目标上方时运行脚本) ondrop(当拖动元素时运行脚本)是必须事件，否则拖拽不正常
	ondrag : function() {
		var box = document.getElementById("maybe_dropbox");
		var handleDragover = function(e) {
			$(box).css("border-color", "#808080");
			e.stopPropagation();
			e.preventDefault();
		}
		var handlePrevent = function(e) {
			e.stopPropagation();
			e.preventDefault();
		}
		var handleDragleave = function(e) { //当元素离开有效拖放目标时运行脚本
			$(box).css("border-color", "#ccc");
			e.preventDefault();
		}
		document.ondragleave = handleDragleave;
		document.ondragover = handleDragover;
		document.ondrop = handlePrevent;
		if(window.parent) {
			parent.document.ondragover = handleDragover;
			parent.document.ondrop = handlePrevent;
		}
		box.ondragover = handleDragover;
		box.ondrop = function(e){
			$(box).css("border-color", "#ccc");
			$("#maybe_img_upfile").hide();
			e.stopPropagation();
			e.preventDefault();
			kpUpload.ajaxUpload(e.dataTransfer.files);
		};
	},

	// 缩放图片尺寸
	scaleImg : function (img, maxW, maxH) {
		var width = 0, height = 0, percent, ow = img.width, oh = img.height;
		if(ow > maxW || oh > maxH) {
			if(ow >= oh) {
				var width = ow - maxW;
				if(width >= 0) {
					percent = (width / ow).toFixed(2);
					var h = oh - oh * percent;
					img.height = h;
					img.width = maxW;
					img.style.marginTop = (maxH-h)/2+"px";
				}
			}else{
				if(height = oh - maxH) {
					percent = (height / oh).toFixed(2);
					img.width = ow - ow * percent;
					img.height = maxH;
				}
			}
		}
	},

	//增加图片显示
	boxAdd : function(file, big, thumb, aid) {
		var img = document.createElement("img");
		var div = $('<div class="d_img"></div>').append(img);
		var inps = '<input name="images['+aid+'][big]" value="'+big+'" type="hidden" />';
			inps += '<input name="images['+aid+'][thumb]" value="'+thumb+'" type="hidden" />';
			inps += '<input name="images['+aid+'][aid]" value="'+aid+'" type="hidden" />'; // 用来删除时使用
			inps += '<textarea name="images['+aid+'][content]" placeholder="请输入描述"></textarea>';
		var d_li = $('<div class="d_li"><div class="d_txt">'+inps+'</div><div class="d_del" aid="'+aid+'">删除</div></div>').prepend(div);
		$("#maybe_imgup").before(d_li);

		$("#maybe_dropbox").kpdragsort(); // 重新绑定拖拽事件
		setdelImg(); // 重新绑定删除事件
		autoSave(); // 发布时会自动保存上传的图集
		editSaveImg(); // 在编辑时，保存一下

		if(typeof file == "object") {
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(e) {
				img.src = e.target.result;
				img.onload = function() {
					kpUpload.scaleImg(this, 120, 100);
				}
			};
		}else if(typeof file == "string") {
			img.src = file;
			img.onload = function() {
				kpUpload.scaleImg(this, 120, 100);
			}
		}
	},

	// 判断是否图片
	isImg : function(type) {
		switch (type) {
			case 'image/jpg':
			case 'image/jpeg':
			case 'image/gif':
			case 'image/png':
				return true;
			default:
				return false;
		}
	},

	//按顺序ajax上传
	ajaxUpload : function(files) {
		var upload = function(i) {
			if(typeof files[i] == 'object') {
				var f = files[i];

				if(!kpUpload.isImg(f.type)) {
					upload(i+1);
					return;
				}

				var xhr = new XMLHttpRequest();
				xhr.open("post", "index.php?u=attach-upload_image&type=img&ajax=1{$edit_cid_id}", true);
				xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

				//模拟数据
				var fd = new FormData();
				fd.append("upfile", f);
				xhr.send(fd);

				xhr.addEventListener('load', function (e) {
					var data = toJson(e.target.response);

					if(data.state == "SUCCESS") {
						kpUpload.boxAdd("../"+data.thumb, data.path, data.thumb, data.aid);
						setTimeout(function(){ upload(i+1); }, 50);

						if(i == files.length - 1) {
							setImgBut(); // 图集上传按钮
						}
					}else{
						setImgBut();
					}
				});
			}
		}
		upload(0);
	}
};

//拖拽插件
$.fn.kpdragsort = function(options) {
	var container = this;

	$(container).children(".d_li").off("mousedown").mousedown(function(e) {
		if(e.which != 1 || $(e.target).is("input, textarea, a") || window.kp_only) return; // 排除非左击和其他元素
		e.preventDefault(); // 阻止选中文本

		var x = e.pageX;
		var y = e.pageY;
		var _this = $(this); // 点击选中块
		var w = _this.width();
		var h = _this.height();
		var w2 = w/2;
		var h2 = h/2;
		var p = _this.position();
		var left = p.left;
		var top = p.top;
		var sTop = $(".p:first").scrollTop();
		window.kp_only = true;

		// 添加虚线框
		_this.before('<div id="kp_widget_holder"></div>');
		var wid = $("#kp_widget_holder");
		wid.css({"border":"1px dashed #ccc", "float":"left", "width":"120px", "height":"120px", "margin":"5px 0 0 5px"});

		// 保持原来的宽高
		_this.css({"width":w, "height":h, "position":"absolute", opacity: 0.8, "z-index": 999, "left":left, "top":top});

		// 绑定mousemove事件
		$(document).mousemove(function(e) {
			e.preventDefault();

			// 移动选中块
			var l = left + e.pageX - x;
			var t = top + ($(".p:first").scrollTop() - sTop) + e.pageY - y;
			_this.css({"left":l, "top":t});

			// 选中块的中心坐标
			var ml = l+w2;
			var mt = t+h2;

			// 遍历所有块的坐标
			$(container).children(".d_li").not(_this).not(wid).each(function(i) {
				var obj = $(this);
				var p = obj.position();
				var a1 = p.left;
				var a2 = p.left + obj.width();
				var a3 = p.top;
				var a4 = p.top + obj.height();

				// 移动虚线框
				if(a1 < ml && ml < a2 && a3 < mt && mt < a4) {
					if(!obj.next("#kp_widget_holder").length) {
						wid.insertAfter(this);
					}else{
						wid.insertBefore(this);
					}
					return;
				}
			});
		});

		// 绑定mouseup事件
		var _mouseup = function() {
			$(document).off('mouseup').off('mousemove');

			// 拖拽回位，并删除虚线框
			var p = wid.position();
			_this.animate({"left":p.left, "top":p.top}, 100, function() {
				_this.removeAttr("style");
				wid.replaceWith(_this);

				setImgBut(); // 重新定位上传按钮
				autoSave(); // 发布时会自动保存上传的图集
				editSaveImg(); // 在编辑时，保存一下

				window.kp_only = null;
				if(parent) parent.document.onmouseup = null;
			});
		};
		$(document).mouseup(_mouseup);
		if(parent) parent.document.onmouseup = _mouseup;
	});
}

// 设置显示缩略图 (iframe使用)
function setDisplayPic(path, thumb) {
	$("#maybe_pic_val").val(thumb);
	$("#maybe_pic_img").attr("src", "../"+thumb);
	autoSave();
}

// 图集中插入新图 (iframe使用)
function setDisplayImg(path, thumb, aid) {
	$("#maybe_img_upfile").hide();
	kpUpload.boxAdd("../"+thumb, path, thumb, aid);
	setImgBut(); // 重新定位上传按钮
}

// 定位缩略图上传按钮
function setPicBut() {
	var obj = $("#maybe_pic_but"),
		p = obj.position(),
		w = obj.outerWidth(true),
		h = obj.outerHeight(true),
		r = $(document).width() - w - p.left;
	$("#maybe_pic_upfile").hover(function(){
		obj.addClass("but_on");
	}, function(){
		obj.removeClass("but_on");
	}).show().css({"position":"absolute", "top":p.top, "right":r, "width":w, "height":h});
}

// 定位图集上传按钮
function setImgBut() {
	if(!$("#maybe_img_but").length) return;
	var isIE = !!window.ActiveXObject;
	var obj = $("#maybe_img_but");
	var p = obj.position();
	var top = isIE  ? p.top-10 : p.top+15;
	$("#maybe_img_upfile").hover(function(){
		obj.addClass("but_on");
	}, function(){
		obj.removeClass("but_on");
	}).show().css({"position":"absolute", "top":top, "left":p.left, "width":obj.outerWidth(true), "height":obj.outerHeight(true)});
}

// 删除单张图集的图片
function setdelImg() {
	$(".d_del").off("mousedown").mousedown(function(e) {
		e.stopPropagation(); // 清除事件冒泡，以免影响拖拽插件
	}).off("click").click(function() {
		var _me = $(this);
		var aid = _me.attr("aid");
		maybeAjax.post("index.php?u=product-del_attach-ajax-1", {"aid":aid}, function(html) {
			// var data = toJson(html);

			// 历史遗留问题，以前是没有aid的，会导致删除失败
			// if(data.err == 0) {
				_me.parent().remove();
			// }

			setImgBut(); // 重新定位上传按钮
			autoSave(); // 在发表时，保存一下
			editSaveImg(); // 在编辑时，保存一下
		});
	});
}

// 定位按钮和加载图集上传
setPicBut();
setImgBut();
kpUpload.init();
$("#maybe_dropbox").kpdragsort();
setdelImg();
	
    oInitJson = {
            tiptype:3
        };
        var oVdForm = $("#myform").Validform(oInitJson);
        oVdForm.addRule([
			{
			    ele:"#cid",
			    datatype:"/^[0-9]*[1-9][0-9]*$/",
			    altercss:"tipColor",
			    nullmsg:"请选择分类",
			    errormsg:"请选择分类"
			},
            {
                ele:"#title",
                datatype:"*",
                altercss:"tipColor",
                nullmsg:"请输入标题",
                errormsg:"标题不能为空"
            }
        ]);
</script>

{hook:admin_content_add_after.htm}

{inc:footer.htm}